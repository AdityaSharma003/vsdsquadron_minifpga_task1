FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:1

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# 1) Install Core Hardware and Build Dependencies
RUN apt-get update && apt-get install -y \
    git curl wget build-essential gcc g++ make pkg-config \
    autoconf automake autotools-dev libtool \
    bison flex texinfo gperf patchutils \
    gawk libmpc-dev libmpfr-dev libgmp-dev \
    zlib1g-dev libexpat1-dev \
    device-tree-compiler libfdt-dev \
    python3 iverilog gtkwave nano vim \
 && rm -rf /var/lib/apt/lists/*

# 2) Download and Install RISC-V Toolchain
# Fixed: We set the PATH globally here so Sections 3 and 4 can see the compiler
WORKDIR /opt
RUN wget -q https://static.dev.sifive.com/dev-tools/riscv64-unknown-elf-gcc-8.3.0-2019.08.0-x86_64-linux-ubuntu14.tar.gz \
 && tar -xzf riscv64-unknown-elf-gcc-8.3.0-2019.08.0-x86_64-linux-ubuntu14.tar.gz \
 && mv riscv64-unknown-elf-gcc-8.3.0-2019.08.0-x86_64-linux-ubuntu14 /opt/riscv \
 && rm -f *.tar.gz

# Set PATH early so the following RUN commands can use the RISC-V compiler
ENV PATH="/opt/riscv/bin:${PATH}"

# 3) Build Spike (The RISC-V ISA Simulator)
WORKDIR /tmp
RUN git clone --depth 1 https://github.com/riscv-software-src/riscv-isa-sim.git \
 && cd riscv-isa-sim && mkdir build && cd build \
 && ../configure --prefix=/opt/riscv \
 && make -j$(nproc) && make install \
 && rm -rf /tmp/*

# 4) Build riscv-pk (The Proxy Kernel) - STABLE TAG VERSION
WORKDIR /tmp
RUN git clone https://github.com/riscv-software-src/riscv-pk.git \
 && cd riscv-pk \
 && git fetch --tags \
 && git checkout v1.0.0 \
 && mkdir build && cd build \
 && ../configure --prefix=/opt/riscv --host=riscv64-unknown-elf \
 && make -j$(nproc) && make install \
 && rm -rf /tmp/*

# 5) Final Workspace Setup
WORKDIR /work
CMD ["/bin/bash"]
